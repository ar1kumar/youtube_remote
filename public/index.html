<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Server - Youtube remote</title>
	
	<script src="/socket.io/socket.io.js"></script>
	<script src="js/jquery.js"></script>
	<link rel="stylesheet" href="css/custom.css" />
	<!-- <script src="https://www.youtube.com/iframe_api"></script> -->
	<!-- unsemantic framework assets - code RA14 -->
	<!-- unsemantic framework -->
	<!--[if lt IE 9]>
	  <script src="./assets/javascripts/html5.js"></script>
	<![endif]-->
	<link rel="stylesheet" href="./assets/stylesheets/demo.css" />
	<link rel="stylesheet" href="./assets/stylesheets/unsemantic-grid-base.css" />
	<noscript>
	  <link rel="stylesheet" href="./assets/stylesheets/unsemantic-grid-mobile.css" />
	</noscript>
	<script>
	  var ADAPT_CONFIG = {
	    path: './assets/stylesheets/',
	    dynamic: true,
	    range: [
	      '0 to 767px = unsemantic-grid-mobile.css',
	      '767px = unsemantic-grid-desktop.css'
	    ]
	  };
	</script>
	<script src="./assets/javascripts/adapt.min.js"></script>
	<!-- Code RA14 ends here -->

</head>
<body>
	<div class="container">
	
	<!-- other objects in the room -->
	<div class="side_objects grid-40 prefix-60">
		<img src="img/right_item.png" alt="" class="grid-50 prefix-50">
	</div>
	<div class="speaker grid-30 prefix-5">
		<img src="img/speaker.png" alt="" class="grid-30">
	</div>
	<div class="bottom_object grid-80 prefix-20">
		<img src="img/desk.png" alt="" class="grid-60 prefix-10"/>
	</div>
	
	
	<h2 id="link_bar" class="grid-60 prefix-20"></h2>
		<div class="bars grid-100 clear_fix">
			<input type="text" name="video_name" placeholder="Enter video or Playlist url" id="vid_link" class="grid-45 prefix-25"/><button id="submit" class="grid-5">GO!!</button>	
		</div>
		<!-- <iframe src="" frameborder="0" class="video" id="video" allowfullscreen></iframe> -->
		<div id="player" class="grid-60 prefix-20"></div>
	</div>
	<script>
			function randomString(len) {
			    //var chars = "1234567890abcdefghijklmnopqrstuvwxyz";
			    var chars = "1";
			    var string_length = len;
			    var randomstring = '';
			    for (var i = 0; i < string_length; i++) {
			        var rnum = Math.floor(Math.random() * chars.length);
			        randomstring += chars.substring(rnum, rnum + 1);
			    }
			    return randomstring;
			}

	
		$(document).ready(function(){
			 
			//var baseURL = "http://192.168.1.109:3000/"
			var baseURL = "https://leanback.herokuapp.com/";
			var roomURL = baseURL+"mobile/"+roomId;	
			var socket = io.connect(baseURL);
			//var roomId = randomString(4);
			var roomId = randomString(1);
			      
			//start a room
			//generate url for mobile to join room
			//restrict room for two clients
			//listen for incoming actions
			
			
			//room created
			socket.emit('new_room', roomId);
		
			//url for mobile generated
			console.log('mobile-link- '+baseURL+'m/'+roomId);
			$('#link_bar').html('Remote URL- '+baseURL+'m/'+roomId)
			
			/* embed video from input link */
			$('#submit').click(function(){
				get_vid = $('#vid_link').val();
				if(get_vid == "" || get_vid == null || get_vid == " "){
					alert('Please enter a youtube link');
				}else{
					vid_id = extractVideoID(get_vid);	
					console.log('video info 2 - '+vid_id[0]+'-::-'+vid_id[1]);
					onYouTubeIframeAPIReady(vid_id[0],vid_id[1]);
					console.log('click');
				}
				//vid_id = extractVideoID(get_vid);
				//onYouTubeIframeAPIReady(vid_id);
			})
				
			/* Get video id from entered url	 */
			function extractVideoID(url){
			    var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
			    var match = url.match(regExp);
			    if ( match && match[7].length == 11 ){
			        var playlist = youtube_playlist_parser(url);
			        var video_id = match[7];
			        return [video_id, playlist];
			        //console.log('video info - '+video_id+'-::-'+playlist)
			    }else{
			        alert("Could not get video.");
			    }
			}
			
			//get playlist id from url
		    function youtube_playlist_parser(url){
			    var reg = new RegExp("[&?]list=([a-z0-9_-]+)","i");
		        var match = reg.exec(url);
		
		        //if (match&&match[1].length>0&&youtube_validate(url)){
		        if (match&&match[1].length>0){
		            return match[1];
		        }else{
		            return "nope";
		        }
		
		    }    

		  // validate if its a youtube URL
		  function youtube_validate(url) {
			  var regExp = /^(?:https?:\/\/)?(?:www\.)?youtube\.com(?:\S+)?$/;
			  return url.match(regExp)&&url.match(regExp).length>0;
		  }
		    
/*
			function control(){
			 	socket.emit('play/pause', data);
			}
*/
			 
				//2. This code loads the IFrame Player API code asynchronously.
			      var tag = document.createElement('script');
			
			      tag.src = "https://www.youtube.com/iframe_api";
			      var firstScriptTag = document.getElementsByTagName('script')[0];
			      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
			
			      // 3. This function creates an <iframe> (and YouTube player)
			      //    after the API code downloads.
			      //var player;
			      function onYouTubeIframeAPIReady(url,playlist) {
			        player = new YT.Player('player', {
			          height: '350',
			          width: '640',
			          videoId: url,
			          playerVars: { 'list':playlist, 'autoplay': 0, 'controls': 0,'rel':0, 'showinfo':0, 'enablejsapi':1 },
			          events: {
			            'onReady': onPlayerReady
			            //'onStateChange': onPlayerStateChange
			          }
			        });
			        player.loadVideoById(url);
			        console.log(url+" - video id updated")
			        /* $('#player').attr('src','https://www.youtube.com/embed/'+url+'?list='+playlist+'&autoplay=0&showinfo=0&rel=0&version=3&enablejsapi=1&controls=0'); */
			      }
			      
			      // 4. The API will call this function when the video player is ready.
			      function onPlayerReady(event) {
			        //event.target.playVideo();
			        //do whatever when the player is ready
			        player.playVideo();
			      }
			      
			      //actions coming from remote URL
			      socket.on('play/pause', function(data){
				 	//alert('reaction');
				 	control = data.action;
				 	//alert(control);
				 	if(control == 'pause'){
					 	player.pauseVideo();
				 	}else if(control == 'play'){
					 	player.playVideo();

				 	}
				});
				
				socket.on('volume', function(data){
				 	new_volume = data.volume;
				 	console.log('volume- '+new_volume);
				 	player.setVolume(new_volume);
				});
				
				socket.on('reaction', function(data){
				 	control = data.action;
				 	if(control == 'next'){
					 	player.nextVideo();
				 	}else if(control == 'prev'){
					 	player.previousVideo();
					}
				});
				
				socket.on('new_video', function(data){
				 	new_video = data.video;
				 	//console.log(new_video+" -new video")
				 	onYouTubeIframeAPIReady(new_video,"none");
				});
		
			})
	
	</script>	
<!-- Google analytics code -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61584005-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- GA code ends here -->
</body>
</html>